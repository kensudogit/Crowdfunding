# Railway 502エラー 修正手順（ステップバイステップ）

## 🚨 現在の状況

ブラウザのコンソールで502エラーが発生しています。これは、バックエンドサーバーが起動していないか、正しく応答していないことを示しています。

## ✅ 修正手順（画面に沿って実行）

### ステップ1: Railwayダッシュボードを開く

1. ブラウザで [https://railway.app/dashboard](https://railway.app/dashboard) にアクセス
2. ログイン（まだログインしていない場合）
3. **Crowdfundingプロジェクト**をクリック

### ステップ2: バックエンドサービスを選択

1. プロジェクト内のサービス一覧から**バックエンドサービス**をクリック
   - サービス名は `backend` または類似の名前

### ステップ3: 環境変数を確認・修正（最重要）

1. バックエンドサービスのページで、上部のタブから「**Variables**」をクリック
2. 環境変数の一覧が表示されます
3. **`PORT`という名前の環境変数を探す**
   - もし`PORT`環境変数が存在する場合：
     - `PORT`の行の右側にある「**...**」（3つの点）をクリック
     - 「**Delete**」をクリック
     - 確認ダイアログで「**Delete**」をクリック
   - **重要**: `PORT`環境変数は**削除してください**（Railwayが自動設定します）

4. 以下の環境変数が設定されているか確認：

| 変数名 | 値 | 必須 |
|--------|-----|------|
| `NODE_ENV` | `production` | ✅ |
| `DB_HOST` | `${{Postgres.PGHOST}}` | ✅ |
| `DB_PORT` | `${{Postgres.PGPORT}}` | ✅ |
| `DB_NAME` | `${{Postgres.PGDATABASE}}` | ✅ |
| `DB_USER` | `${{Postgres.PGUSER}}` | ✅ |
| `DB_PASSWORD` | `${{Postgres.PGPASSWORD}}` | ✅ |
| `JWT_SECRET` | `<強力なランダム文字列>` | ✅ |
| `FRONTEND_URL` | `https://<フロントエンドのURL>` | ✅ |
| `CORS_ORIGIN` | `https://<フロントエンドのURL>` | ✅ |

**注意**: 
- `Postgres`は実際のPostgreSQLサービス名に合わせて変更してください
- 環境変数が不足している場合は、「**+ New Variable**」ボタンをクリックして追加

### ステップ4: 公開設定を確認

1. バックエンドサービスのページで、上部のタブから「**Settings**」をクリック
2. 左側のメニューから「**Networking**」をクリック
3. 以下を確認：
   - 「**Generate Domain**」ボタンが表示されている場合、クリックして公開ドメインを生成
   - 「**Public**」というトグルスイッチが**ON**になっているか確認
     - OFFの場合は、**ONに切り替える**（完全公開モード）
   - 生成されたURLをメモ（例: `https://crowdfunding-backend-production.up.railway.app`）

### ステップ5: 再デプロイ

1. バックエンドサービスのページで、上部のタブから「**Settings**」をクリック
2. 左側のメニューから「**Deployments**」をクリック
3. 「**Redeploy**」ボタンをクリック
4. 確認ダイアログで「**Redeploy**」をクリック
5. デプロイが完了するまで待つ（5-10分）
   - 画面上部にデプロイの進行状況が表示されます

### ステップ6: デプロイログを確認

1. デプロイが完了したら、「**Deployments**」タブで最新のデプロイメントをクリック
2. 「**View Logs**」ボタンをクリック
3. ログを確認し、以下のメッセージが表示されれば成功：

```
✓ Server is running on port <PORT>
✓ Listening on 0.0.0.0:<PORT>
✓ Database connection successful.
```

**エラーメッセージが表示される場合：**

#### エラー1: ポート使用エラー
```
Error: Port 8000 is already in use
```
**解決方法**: ステップ3で`PORT`環境変数を削除したことを確認し、再度再デプロイ

#### エラー2: データベース接続エラー
```
✗ Error: Could not connect to database
```
**解決方法**: 
1. PostgreSQLサービスが起動しているか確認（プロジェクト内のサービス一覧で確認）
2. 環境変数の`${{Postgres.*}}`の`Postgres`が実際のサービス名と一致しているか確認
3. 環境変数を修正して再デプロイ

#### エラー3: ビルドエラー
```
error TS2307: Cannot find module
```
**解決方法**: 
1. ビルドログのエラーメッセージを確認
2. 必要に応じてコードを修正
3. GitHubにプッシュして再デプロイ

### ステップ7: 動作確認

1. **バックエンドヘルスチェック**
   - ブラウザで以下にアクセス：
     ```
     https://<バックエンドのURL>/api/health
     ```
   - 正常な場合、以下のJSONが返されます：
     ```json
     {
       "status": "healthy",
       "timestamp": "2026-02-08T..."
     }
     ```

2. **ルートエンドポイント**
   - ブラウザで以下にアクセス：
     ```
     https://<バックエンドのURL>/
     ```
   - 正常な場合、以下のJSONが返されます：
     ```json
     {
       "message": "Crowdfunding API",
       "version": "1.0.0",
       "status": "running"
     }
     ```

3. **Railway HTTPログ**
   - Railwayダッシュボードでバックエンドサービスを開く
   - 「**HTTP Logs**」タブをクリック
   - 最新のリクエストを確認
   - ステータスコードが**200**になっているか確認

4. **ブラウザのコンソール**
   - ブラウザの開発者ツール（F12）を開く
   - 「**Console**」タブを確認
   - 502エラーが解消されているか確認

## 🔄 まだ502エラーが発生する場合

### 追加確認事項

1. **PostgreSQLサービスが起動しているか確認**
   - プロジェクト内のサービス一覧でPostgreSQLサービスを確認
   - 起動していない場合は、サービスをクリックして起動

2. **データベース環境変数のサービス名を確認**
   - PostgreSQLサービスの名前を確認（通常は`Postgres`）
   - バックエンドの環境変数で`${{Postgres.*}}`の`Postgres`が実際のサービス名と一致しているか確認
   - 一致していない場合は、環境変数を修正

3. **公開設定を再確認**
   - 「Settings」→「Networking」で「Public」トグルがONになっているか確認

4. **デプロイログを詳細に確認**
   - 「Deployments」→「View Logs」でエラーメッセージを確認
   - エラーメッセージに従って修正

## 🆘 完全リセット（最後の手段）

すべてがうまくいかない場合：

1. **バックエンドサービスを削除**
   - バックエンドサービス → 「Settings」→ 一番下の「**Delete Service**」をクリック
   - 確認ダイアログで「**Delete**」をクリック

2. **バックエンドサービスを再作成**
   - プロジェクトページで「**+ New**」をクリック
   - 「**GitHub Repo**」を選択
   - リポジトリを選択
   - 「**Settings**」タブで以下を設定：
     - **Root Directory**: `backend`
     - **Dockerfile Path**: `Dockerfile.prod`

3. **環境変数を設定**
   - 「Variables」タブで環境変数を設定（`PORT`は設定しない）
   - `railway-env-setup.md`を参照

4. **公開設定を確認**
   - 「Settings」→「Networking」
   - 「Generate Domain」をクリック
   - **「Public」トグルをONにする**

5. **デプロイを待つ**

## 📋 チェックリスト

502エラーを解決するために、以下を確認してください：

- [ ] `PORT`環境変数が設定されていない（削除済み）
- [ ] すべての必須環境変数が設定されている
- [ ] PostgreSQLサービスが起動している
- [ ] データベース環境変数のサービス参照が正しい（`${{Postgres.*}}`）
- [ ] 公開ドメインが生成されている
- [ ] **「Public」トグルがONになっている**（完全公開モード）
- [ ] デプロイが完了している
- [ ] ログに「Server is running」が表示されている
- [ ] `/api/health`エンドポイントが応答している
- [ ] HTTPログでステータスコードが200になっている
- [ ] ブラウザのコンソールで502エラーが解消されている

## 📞 参考資料

- **今すぐ修正**: `RAILWAY_502_FIX_NOW.md`
- **詳細診断**: `RAILWAY_502_DIAGNOSIS.md`
- **クイック修正**: `RAILWAY_QUICK_FIX_502.md`
- **完全公開デプロイ**: `RAILWAY_PUBLIC_DEPLOY.md`
- **環境変数設定**: `railway-env-setup.md`
